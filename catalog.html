<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="HTR-United Home Page">
    <meta name="author" content="Alix Chagué">
    <meta name="author" content="Thibault Clérice">
    <title>HTR-United</title>

    <link rel="canonical" href="https://getbootstrap.com/docs/5.0/examples/heroes/">

    <!-- Bootstrap core CSS -->
    <link href="static/css/bootstrap.min.css" rel="stylesheet">
    <!--<link href="/docs/5.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-wEmeIV1mKuiNpC+IOBjI7aAzPcEZeedi5yW5f2yOq55WWLwNGmvvx4Um1vskeMj0" crossorigin="anonymous">-->

    <!-- Favicons -->
    <link rel="icon" href="assets/images/favicon.ico" />
    
    <!-- Icon library -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">


    <style>
    </style>

    <!-- Custom styles for this template -->
    <link href="static/css/personalCSS.css" rel="stylesheet">

  </head>

  <body id="top">

    <!-- navbar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light rounded fixed-top d-flex flex-wrap align-items-center justify-content-center justify-content-md-between border-bottom  py-3 mb-4 px-5 shadow-lg">
        <a class="navbar-brand" href="index.html#top">HTR-United</a>
        <a class="navbar-brand" href="https://github.com/HTR-United"><i class="fab fa-github"></i></a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar_htr-united" aria-controls="navbar_htr-united" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span><!--<i class="far fa-minus-square"></i>-->
        </button>

        <div class="collapse navbar-collapse" id="navbar_htr-united">
          <ul class="navbar-nav my-2 my-md-0 mr-md-3 col-sm-10">
            <li class="nav-item active">
              <a class="nav-link btn btn-nav me-2" href="index.html#use-data"><i18n vanilla-i18n="nav.use">Utiliser les données</i18n></span></a>
            </li>
            <li class="nav-item">
              <a class="nav-link btn btn-nav me-2" href="index.html#provide-data"><i18n vanilla-i18n="nav.provide">Proposer des données</i18n></a>
            </li>
            <li class="nav-item">
              <a class="nav-link btn btn-nav me-2" href="index.html#scenarios"><i18n vanilla-i18n="nav.scenario">Scénarios</i18n></a>
            </li>
            <li class="nav-item">
              <a class="nav-link btn btn-nav-ext me-2" href="document-your-data.html"><i18n vanilla-i18n="nav.form">Voir le formulaire</i18n></a>
            </li>
            <li class="nav-item">
              <a class="nav-link btn btn-nav-ext me-2" href="catalog.html"><i18n vanilla-i18n="nav.catalog">Voir le catalogue</i18n></a>
            </li>
            <li class="nav-item">
              <a class="nav-link btn btn-nav-ext me-2" href="team.html"><i18n vanilla-i18n="nav.team">L'Équipe</i18n></a>
            </li>
          </ul>
          <div class="col-sm-2 text-end">
            <select id="vanilla-i18n-toggler">
              <option>Français</option>
              <option>English</option>
            </select>
            <!--<a class="btn btn-outline-secondary me-2" href="#">English</a>-->
          </div>
        </div>
      </nav>

<!-- Main -->
<main>
  <div class="px-4 py-5 my-5" id="main">
	  <div class="container">
	  	<div class="row">
	  		<h1><i18n vanilla-i18n="cat.title">Catalogue</i18n></h1>
        <div class="row my-2">
            <div class="col-sm-9">
              <p><small class="text-muted"><i18n vanilla-i18n="cat.nota">La langue utilisée pour la description des jeux de données correspond à celle employée lors du dépôt d'un signalement dans HTR-United.</i18n></small></p>
            </div>
        </div>
        <form id="card-selector" class="m-2 border p-2">
          <h3><span  vanilla-i18n="cat.filters">Filtres</span></h3>
          <div class="form-group row my-2">
            <label for="scriptType" class="col-sm-3 col-form-label"><i18n vanilla-i18n="form.field.script.type.label">Type d'écriture</i18n><span class="required">*</span></label>
            <div class="col-sm-9">
              <select name="scriptType" id="scriptType" class="form-control">
                <option value="all" vanilla-i18n="form.field.script.type.select.all">Tout</option>
                <option value="only-manuscript" vanilla-i18n="form.field.script.type.select.only-manuscript">Manuscrit uniquement</option>
                <option value="only-typed" vanilla-i18n="form.field.script.type.select.only-typed">Imprimé/dactylographié uniquement</option>
                <option value="mainly-manuscript" vanilla-i18n="form.field.script.type.select.mainly-manuscript">Principalement manuscrit</option>
                <option value="mainly-typed" vanilla-i18n="form.field.script.type.select.mainly-typed">Principalement imprimé/dactylographié</option>
                <option value="evenly-mixed" vanilla-i18n="form.field.script.type.select.evenly-mixed">Egale répartition manuscrit/dactylographié et imprimé</option>
              </select>
            </div>
          </div>
          <div class="form-group row my-2">
            <label for="scriptType" class="col-md-3 col-form-label">Dates</label>
            <div class="col-md-6">
              <div class="input-group">
                <span class="input-group-text">Not before:</span>
                <input type="number" id="notBefore" aria-label="First name" class="form-control">
                <span class="input-group-text">Not after:</span>
                <input type="number" id="notAfter" aria-label="Last name" class="form-control">
              </div>
            </div>
          </div>
          <hr />
          <div class="form-group row my-2">
            <div class="col-md-3"><span  vanilla-i18n="cat.resultCount">Nombre de résultats:</span></div>
            <div class="col-md-9"><span id="resultCount"></span></div>
          </div>
          <div class="row">
            <div class="col-md-3">Options</div>
            <div class="col-md-9">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" value="affiche" id="showGuidelines">
                <label class="form-check-label" for="showGuidelines">
                  Show Guidelines
                </label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" value="affiche" id="showCitations">
                <label class="form-check-label" for="showCitations">
                  Show Citations
                </label>
              </div>
            </div>
          </div>
        </form>
	  		<div id="card-receiver"></div>

	  	</div>
	  </div>
	</div>

  <!-- Footer -->
  <div class="bg-dark text-secondary px-4 py-2 text-center">
    <div class="py-3">
      <div class="col-lg-6 mx-auto">
        <p class="fs-5 mb-4">HTR-United | 2021</p>
      </div>
      <div class="col-lg-6 mx-auto">
        <p class="fs-5"><a class="btn btn-sm btn-outline-light" href="team.html" target="_blank"><i18n vanilla-i18n="footer.team">Qui est derrière HTR-United ?</i18n></a></p>
      </div>
    </div>
  </div>

</main>

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <!--<script>window.jQuery || document.write('<script src="../../assets/js/vendor/jquery-slim.min.js"><\/script>')</script>-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
    
    <!--<script src="static/js/bootstrap.bundle.min.js" integrity="sha384-p34f1UUtsS3wqzfto5wAAmdvj+osOnFyQFpp4Ua3gs/ZVWx6oOypYoCJhGGScy+8" crossorigin="anonymous"></script>-->

    <!--<script src="/docs/5.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-p34f1UUtsS3wqzfto5wAAmdvj+osOnFyQFpp4Ua3gs/ZVWx6oOypYoCJhGGScy+8" crossorigin="anonymous"></script>-->

    <!-- i18n -->
    <script type="text/javascript" src="static/js/i18n-advanced.js"></script>
    <script type="text/javascript" src="static/js/i18n.js"></script>
    <!-- end of i18n -->
    <script type="text/javascript">
    	const catalogURI = "https://htr-united.github.io/htr-united/catalog.json";
    	const catalogDiv = document.querySelector("#card-receiver"),
            notAfterSelector = document.querySelector("#notAfter"),
            notBeforeSelector = document.querySelector("#notBefore"),
            scriptTypeFilter = document.querySelector("#scriptType"),
            resultCount = document.querySelector("#resultCount"),
            showGuidelines = document.querySelector("#showGuidelines"),
            showCitations = document.querySelector("#showCitations");

      function toggleGuidelines() {
        if (showGuidelines.checked) {
          catalogDiv.classList.add("show-guidelines");
        } else {
          catalogDiv.classList.remove("show-guidelines");
        }
      }
      function toggleCitations() {
        if (showGuidelines.checked) {
          catalogDiv.classList.add("show-citations");
        } else {
          catalogDiv.classList.remove("show-citations");
        }
      }



    	function nl2br (str, is_xhtml) { return (str + '').replace(/([^>\r\n]?)(\r\n|\n\r|\r|\n)/g, '$1<br />$2'); }
    	function createElementFromHTML(htmlString) {
  		  let div = document.createElement('div');
  		  div.innerHTML = htmlString.trim();

  		  // Change this to div.childNodes to support multiple top-level nodes.
  		  return div.firstChild;
  		}
    function slugify(str) {
      str = str.replace(/^\s+|\s+$/g, '');

      // Make the string lowercase
      str = str.toLowerCase();

      // Remove accents, swap ñ for n, etc
      var from = "ÁÄÂÀÃÅČÇĆĎÉĚËÈÊẼĔȆÍÌÎÏŇÑÓÖÒÔÕØŘŔŠŤÚŮÜÙÛÝŸŽáäâàãåčçćďéěëèêẽĕȇíìîïňñóöòôõøðřŕšťúůüùûýÿžþÞĐđßÆa·/_,:;";
      var to   = "AAAAAACCCDEEEEEEEEIIIINNOOOOOORRSTUUUUUYYZaaaaaacccdeeeeeeeeiiiinnooooooorrstuuuuuyyzbBDdBAa------";
      for (var i=0, l=from.length ; i<l ; i++) {
          str = str.replace(new RegExp(from.charAt(i), 'g'), to.charAt(i));
      }

      // Remove invalid chars
      str = str.replace(/[^a-z0-9 -]/g, '') 
      // Collapse whitespace and replace by -
      .replace(/\s+/g, '-') 
      // Collapse dashes
      .replace(/-+/g, '-'); 

      return str;
    }
    function getVolumes(listOfValue) {
      return listOfValue.map((val) => `<span class="badge badge-sm text-white p-0 m-1"><span class="bg-secondary py-1 px-2 rounded-left"><span class="fas fa-database"></span> Volume</span><span class="py-1 px-2 rounded-right badge-volumes">${val.count.toLocaleString()} ${val.metric}</span></span>`).join(" ")
    }
		function getImages(listOfValue, label, color) {
			return listOfValue.map((val) => `<span class="badge badge-sm text-white p-0 m-1"><span class="bg-secondary py-1 px-2 rounded-left">${label}</span><span class="py-1 px-2 rounded-right badge-${color}">${val}</span></span>`).join(" ")
		}
    function getTypeBadge(scriptType) {
      // fa-print
      // fa-pen
      // fa-archive
      if (typeof scriptType !== "string") {
        return "";
      }
      let badge = "fa-archive";
      if (scriptType.includes("manuscript")) { badge = "fa-pen-fancy"; } else if (scriptType.includes("typed")) { badge = "fa-print"; }
      return `<span class="badge badge-sm text-white p-0 m-1">
        <span class="bg-secondary py-1 px-2 rounded-left">Script Type</span><span class="py-1 px-2 rounded-right badge-script-type"><span class="fas ${badge}"></span> ${scriptType}</span>
      </span>`
    }
    function citationCFF(link) {
      if(link) {
        return `<a href="${link}"><span class="badge badge-sm text-white p-0 m-1"><span class="bg-secondary py-1 px-2 rounded-left">Link</span><span class="py-1 px-2 rounded-right badge-link">Citation File</span></span>
      </a>`;
      } else { return ""; }
    }
    function getAuthors(catalogEntry) {
      if (catalogEntry.authors) {
        return `<p class="card-text"><b>Authors:</b> ${catalogEntry.authors.map((val) => val.name + ', ' + val.surname).join(' and ')}</p>`;
      } else {
        return "";
      }
    }
    function transcriptionRules(catalogEntry) {
      if (catalogEntry['transcription-guidelines']) {
        return `
  <div class="card-body transcriptionRules">
    <h6>Transcriptions Guidelines</h6>
    <p class="card-text">${catalogEntry['transcription-guidelines']}</p>
  </div>`;
      } else {
        return "";
      }
    }
    function template(catalogEntry, key) {
    		return createElementFromHTML(`<div class="card float-left catalog-card"  data-key="${key}">
  <div class="card-header">
  ${catalogEntry.title}
  </div>
  <div class="card-body">
    <h6 class="card-subtitle mb-2 text-muted">${catalogEntry['project-name'] || ''}</h6>
    <h7>${catalogEntry.time.notBefore.split('-')[0]}--${catalogEntry.time.notAfter.split('-')[0]}</h7>
    <p>
      ${getImages(catalogEntry.language, "Language", "language")}
      ${getImages(catalogEntry.script, "Script", "script")}
      ${getTypeBadge(catalogEntry['script-type'])}
      <span class="badge badge-sm text-white p-0 m-1"><span class="bg-secondary py-1 px-2 rounded-left">Hands</span><span class="py-1 px-2 rounded-right badge-hands">${catalogEntry.hands.count}</span></span>
      <span class="badge badge-sm text-white p-0 m-1"><span class="bg-secondary py-1 px-2 rounded-left">License</span><span class="py-1 px-2 rounded-right badge-license">${catalogEntry.license[0].name}</span></span>
    </p>
    <p>${getVolumes(catalogEntry.volume)}</p>
    <p>
      <a href="${catalogEntry.url}"><span class="badge badge-sm text-white p-0 m-1"><span class="bg-secondary py-1 px-2 rounded-left">Link</span><span class="py-1 px-2 rounded-right badge-link">Data</span></span></a>
      ${citationCFF(catalogEntry['citation-file-link'])}
    </p>
    <p class="card-text">${nl2br(catalogEntry.description)}</p>
    ${getAuthors(catalogEntry)}
  </div>
  ${transcriptionRules(catalogEntry)}
  <div class="card-body citation">
  <h6>Citation <span class="fas fa-copy citation-copy"></span></h6>
  <pre>
@misc{htr_united_${slugify(catalogEntry.url)},
  type       = dataset,
  author     = {${(catalogEntry.authors || []).map((val) => val.name + ', ' + val.surname).join(' and ')}},
  title      = {${catalogEntry.title}},
  publisher  = {HTR United},
  editor     = {Chagué, Alix and Clérice, Thibault},
  url        = {${catalogEntry.url}}
}</pre>
</div>
</div>`);
    	}
    	async function getCatalog() {
		    try {
		      var res = await fetch(catalogURI);
		      return res.json();
		    } catch {
		      (error) => {
		        console.log(error.message);
		        return;
		      };
		    }
		};
    function selectText(node) {
      if (document.body.createTextRange) {
        const range = document.body.createTextRange();
        range.moveToElementText(node);
        range.select();
      } else if (window.getSelection) {
          const selection = window.getSelection();
          const range = document.createRange();
          range.selectNodeContents(node);
          selection.removeAllRanges();
          selection.addRange(range);
      }
    }
		async function showCatalog() {
			const CATALOG = await getCatalog();
      let minDate = +5000, 
          maxDate = -5000;
      let knownDates = [];
      let selectedDates = [];
			Object.keys(CATALOG).forEach( (key) => {
        let div = template(CATALOG[key], key);
        try {
          CATALOG[key].time.notBeforeInt = parseInt(CATALOG[key].time.notBefore.split("-")[0]);
          CATALOG[key].time.notAfterInt = parseInt(CATALOG[key].time.notAfter.split("-")[0]);
          if (CATALOG[key].time.notAfterInt > maxDate) {
            maxDate = CATALOG[key].time.notAfterInt;
          }
          if (CATALOG[key].time.notBeforeInt < minDate) {
            minDate = CATALOG[key].time.notBeforeInt;
          }
          knownDates.push({start: CATALOG[key].time.notBeforeInt, end: CATALOG[key].time.notAfterInt});
          selectedDates.push({start: CATALOG[key].time.notBeforeInt, end: CATALOG[key].time.notAfterInt});
        } catch (e) {
          console.log("Error on parsing time for " + key);
          console.log(e);
        }
				catalogDiv.append(div);
			});
      catalogDiv.querySelectorAll(".citation").forEach((divEl) => {
        divEl.querySelector(".citation-copy").addEventListener("click", function(e) {
          selectText(divEl.querySelector("pre"));
          document.execCommand("copy");
        })
      });
      notBeforeSelector.value = minDate;
      notAfterSelector.value = maxDate;

      function inRange(minStart, minEnd, dataStart, dataEnd) {
        return (dataStart <= minEnd) && (minStart <= dataEnd);
      }
      function scriptTypeFilterFn(entry, filterValue) {
        if (filterValue == "all") { return true; }
        return (entry['script-type'] == filterValue);
      }
      function updateResultCount() {
        resultCount.innerText = catalogDiv.querySelectorAll(".card:not([style*='none'])").length;
      }

      function applyFilters() {
        let localMin = parseInt(notBeforeSelector.value),
            localMax = parseInt(notAfterSelector.value),
            localSelected = knownDates.filter((val) => inRange(localMin, localMax, val.start, val.end)),
            localScriptTypeFilter = scriptTypeFilter.value;

        // Avoids rerunning things on divs if things did not change
        //if (localSelected.sort() !== selectedDates.sort()) {
          // Refresh the list
        selectedDates = localSelected;
        document.querySelectorAll(".catalog-card").forEach((div) => div.style.display = "none");
        Object.keys(CATALOG).forEach( (key) => {
          if (
              // Filter for dates
              (inRange(localMin, localMax, CATALOG[key].time.notBeforeInt, CATALOG[key].time.notAfterInt)) &&
              // Filter for script
              (scriptTypeFilterFn(CATALOG[key], localScriptTypeFilter))
            ) {
            document.querySelector(`.catalog-card[data-key="${key}"]`).style.display = "block";
          }
        });
        //}
        updateResultCount();
      };
      notBeforeSelector.addEventListener('change', applyFilters);
      notAfterSelector.addEventListener('change', applyFilters);
      scriptTypeFilter.addEventListener('change', applyFilters);
      toggleGuidelines();
      toggleCitations();
      applyFilters();
		}
    showGuidelines.addEventListener("change", toggleGuidelines);
    showCitations.addEventListener("change", toggleCitations);
		showCatalog();
    </script>
      
  </body>
</html>
